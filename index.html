<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>TENG食譜管理系統 v3.1 - 離線版</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 保持所有原有樣式不變 */
    :root {
      --primary: #4a6fa5;
      --primary-light: #6d8fc7;
      --primary-dark: #2a4b7a;
      --secondary: #6c757d;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --card-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --border-radius: 12px;
      --font-family: "微軟正黑體", "Helvetica Neue", Arial, sans-serif;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-family);
      line-height: 1.6;
      color: var(--dark);
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      text-align: center; margin-bottom: 30px; padding: 25px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow);
      transition: var(--transition);
    }
    .header:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
    .header h1 {
      font-size: 2.5rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px;
    }
    .header p { font-size: 1.1rem; opacity: 0.9; max-width: 600px; margin: 0 auto; }
    .tab-container { display: flex; margin-bottom: 25px; background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--card-shadow); }
    .tab {
      flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: 600;
      font-size: 1.1rem; transition: var(--transition); border-bottom: 4px solid transparent;
    }
    .tab.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
    .tab i { margin-right: 10px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
    .card { background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 25px; margin-bottom: 25px; transition: var(--transition); }
    .card:hover { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
    .card-title { display: flex; align-items: center; color: var(--primary); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray); }
    .card-title i { margin-right: 15px; font-size: 1.8rem; }
    .card-title h2 { font-size: 1.6rem; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--dark); font-size: 1.1rem; }
    input, textarea, select {
      width: 100%; padding: 14px 18px; border: 2px solid var(--light-gray); border-radius: 10px;
      font-size: 1.1rem; transition: var(--transition); font-family: var(--font-family);
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(74, 111, 165, 0.2); }
    .ingredient-grid { display: grid; grid-template-columns: 1.5fr 2.5fr 1.2fr 1.2fr 1.5fr auto; gap: 12px; align-items: center; margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 10px; position: relative; }
    .ingredient-group-header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 2px dashed var(--primary-light); font-weight: bold; color: var(--primary-dark); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 22px; background-color: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 600; text-align: center; transition: var(--transition); }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    .btn-sm { padding: 10px 16px; font-size: 1rem; }
    .btn-danger { background-color: var(--danger); }
    .btn-success { background-color: var(--success); }
    .btn-warning { background-color: var(--warning); color: var(--dark); }
    .btn-secondary { background-color: var(--secondary); }
    .btn-info { background-color: var(--info); }
    .btn-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    .recipe-card { margin-bottom: 25px; padding: 20px; border-radius: var(--border-radius); background: white; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); transition: var(--transition); }
    .recipe-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12); }
    .recipe-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .recipe-title { font-size: 1.8rem; color: var(--primary); font-weight: 700; margin-bottom: 8px; }
    .recipe-meta { color: var(--gray); font-size: 1.1rem; margin-bottom: 15px; font-weight: bold;  }
    .ingredient-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 1.1rem; }
    .ingredient-table th { background-color: var(--primary); color: white; padding: 15px; text-align: left; font-weight: 600; }
    .ingredient-table td { padding: 15px; border-bottom: 1px solid var(--light-gray); }
    .ingredient-table tr:nth-child(even) { background-color: var(--light); }
    .ingredient-group-row { background-color: rgba(74, 111, 165, 0.1) !important; font-weight: bold; }
    .steps-container, .baking-container { background: var(--light); padding: 20px; border-radius: 10px; margin-top: 20px; line-height: 1.8; }
    .search-container { display: flex; gap: 15px; margin-top: 20px; margin-bottom: 20px; }
    .action-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    .empty-state { text-align: center; padding: 50px 20px; color: var(--gray); }
    .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    .empty-state h3 { font-size: 1.5rem; margin-bottom: 15px; }
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: white; border-radius: var(--border-radius); padding: 20px; text-align: center; box-shadow: var(--card-shadow); }
    .stat-card i { font-size: 2.5rem; color: var(--primary); margin-bottom: 15px; }
    .stat-card h3 { font-size: 1.8rem; margin-bottom: 5px; color: var(--primary); }
    .stat-card p { color: var(--gray); font-size: 1.1rem; }
    footer { text-align: center; margin-top: 40px; padding: 20px; color: var(--gray); font-size: 1rem; }
    .baking-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; align-items: center; }
    .baking-options { display: flex; gap: 20px; align-items: center; margin-top: 10px; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
    .checkbox-group input { width: auto; }
    .checkbox-cell { width: 50px; text-align: center; }
    input[type="checkbox"] { accent-color: red; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; flex-direction: column; }
      .btn-group, .action-buttons, .search-container { flex-direction: column; }
      .recipe-header { flex-direction: column; }
      .tab { padding: 14px 10px; font-size: 1rem; }
      .ingredient-grid { grid-template-columns: 1fr; }
    }
    .group-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; background-color: var(--primary-light); color: white; font-size: 0.9rem; margin-right: 8px; }
    .flour-warning { color: var(--danger); font-size: 0.9rem; margin-top: 5px; display: none; }
    .info-box { background-color: #e8f4fd; border-left: 4px solid var(--info); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    .info-box p { margin: 0; color: var(--dark); }
    .add-ingredient-btn-container { text-align: center; margin: 20px 0; }
    .save-progress { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; text-align: center; }
    .save-progress i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 20px; }
    
    /* 搜尋區域樣式 */
    .search-filters {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    .search-filters label {
      margin-bottom: 5px;
      min-width: 80px;
    }
    .search-filters select,
    .search-filters input {
      margin-bottom: 0;
    }

    /* 通知系統樣式 */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .notification {
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 350px;
      animation: slideIn 0.3s ease, fadeOut 0.5s ease 3.5s forwards;
    }
    
    .notification-success {
      background-color: var(--success);
    }
    
    .notification-error {
      background-color: var(--danger);
    }
    
    .notification-warning {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    .notification-info {
      background-color: var(--info);
    }
    
    .notification-icon {
      font-size: 1.2rem;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 1.1rem;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .notification-close:hover {
      opacity: 1;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* 自訂食材列表樣式 */
    .custom-ingredients-list {
      margin-top: 20px;
    }
    
    .custom-ingredients-list h4 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--primary-dark);
    }
    
    .custom-ingredients-list ul {
      list-style-type: none;
      padding: 0;
    }
    
    .custom-ingredients-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background-color: var(--light);
      border-radius: 8px;
      font-size: 1.2rem;
      transition: background-color 0.2s;
    }
    
    .custom-ingredients-list li:hover {
      background-color: var(--light-gray);
    }
    
    .custom-ingredients-list .ingredient-info {
      flex-grow: 1;
    }
    
    .custom-ingredients-list .ingredient-actions {
      display: flex;
      gap: 10px;
    }

    /* 智能換算工具模態窗口樣式 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.active .modal {
      transform: translateY(0);
    }
    
    .modal-header {
      padding: 20px 25px;
      border-bottom: 2px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.5rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .conversion-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
      padding: 20px;
      background: var(--light);
      border-radius: 10px;
    }
    
    .conversion-options {
      display: flex;
      gap: 15px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .conversion-option-btn {
      padding: 10px 15px;
      background: var(--light-gray);
      border: 2px solid var(--light-gray);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .conversion-option-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .conversion-results {
      margin-top: 25px;
    }
    
    .converted-ingredient-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .converted-ingredient-table th {
      background: var(--primary-light);
      color: white;
      padding: 12px;
      text-align: left;
    }
    
    .converted-ingredient-table td {
      padding: 12px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .converted-ingredient-table tr:nth-child(even) {
      background: var(--light);
    }
    
    .weight-change {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .weight-increase {
      color: var(--success);
    }
    
    .weight-decrease {
      color: var(--danger);
    }
    
    /* 離線版本專用樣式 */
    .offline-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      background: var(--success);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 5px;
    }
 /* 輸入框錯誤狀態 */
input.error {
  border-color: var(--danger) !important;
  box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2) !important;
}

/* 模態窗口輸入框樣式 */
.modal-body input[type="text"] {
  font-size: 1.2rem;
  padding: 15px;
  border: 2px solid var(--light-gray);
  border-radius: 10px;
  width: 100%;
  transition: var(--transition);
}

.modal-body input[type="text"]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(74, 111, 165, 0.2);
}

/* 按鈕禁用狀態 */
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}

.btn:disabled:hover {
  transform: none !important;
  box-shadow: none !important;
}   
  </style>
</head>
<body>
  <!-- 離線指示器 -->
  <div class="offline-indicator">
    <i class="fas fa-wifi"></i> 離線模式
  </div>

  <!-- 通知容器 -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- 智能換算工具模態窗口 -->
  <div class="modal-overlay" id="conversionModal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-calculator"></i> 智能食材換算工具</h3>
        <button class="modal-close" onclick="closeConversionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="conversion-controls">
          <div>
            <label for="originalFlour">原始總麵粉量 (g)</label>
            <input type="number" id="originalFlour" readonly>
          </div>
          <div>
            <label for="newFlour">新總麵粉量 (g)</label>
            <input type="number" id="newFlour" min="1" step="1" placeholder="輸入新的麵粉總量">
          </div>
          <div>
            <label for="conversionRatio">換算比例</label>
            <input type="text" id="conversionRatio" readonly>
          </div>
        </div>
        
        <div class="conversion-options">
          <div class="conversion-option-btn active" data-ratio="0.5">½ 倍</div>
          <div class="conversion-option-btn" data-ratio="0.75">¾ 倍</div>
          <div class="conversion-option-btn" data-ratio="1">1 倍 (原始)</div>
          <div class="conversion-option-btn" data-ratio="1.5">1.5 倍</div>
          <div class="conversion-option-btn" data-ratio="2">2 倍</div>
          <div class="conversion-option-btn" data-ratio="2.5">2.5 倍</div>
          <div class="conversion-option-btn" data-ratio="3">3 倍</div>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="includeNonPercentage">
          <label for="includeNonPercentage">同時調整非百分比分組的食材 (如內餡、裝飾等)</label>
        </div>
        
        <button class="btn btn-success" onclick="calculateConversion()" style="margin-top: 15px;">
          <i class="fas fa-calculator"></i> 計算換算結果
        </button>
        
        <div class="conversion-results" id="conversionResults" style="display: none;">
          <h4><i class="fas fa-list-alt"></i> 換算結果</h4>
          <div id="convertedIngredientsTable"></div>
          <div class="btn-group" style="margin-top: 20px;">
            <button class="btn btn-info" onclick="copyConversionResults()">
              <i class="fas fa-copy"></i> 複製結果
            </button>
            <button class="btn btn-success" onclick="applyConversionToForm()">
              <i class="fas fa-edit"></i> 應用到編輯表單
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 匯入 CSV 模態窗口 -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-file-import"></i> 匯入 CSV 檔案</h3>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="info-box">
          <p><i class="fas fa-info-circle"></i> 請選擇要匯入的 CSV 檔案。檔案必須是由原版系統匯出的 CSV 格式，包含「食譜數據」和「食材資料庫」兩個部分。</p>
        </div>
        
        <div class="form-group">
          <label for="csvFile"><i class="fas fa-file-csv"></i> 選擇 CSV 檔案</label>
          <input type="file" id="csvFile" accept=".csv" style="padding: 10px;">
        </div>
        
        <div class="info-box" style="background-color: #fff3cd; border-left-color: #ffc107;">
          <p><i class="fas fa-exclamation-triangle"></i> 注意：匯入將會覆蓋現有的食譜和食材資料！建議先匯出備份。</p>
        </div>
        
        <div class="btn-group" style="margin-top: 20px;">
          <button class="btn btn-success" onclick="importCSV()" id="importBtn">
            <i class="fas fa-file-import"></i> 開始匯入
          </button>
          <button class="btn btn-secondary" onclick="closeImportModal()">
            <i class="fas fa-times"></i> 取消
          </button>
        </div>
        
        <div id="importProgress" style="display: none; text-align: center; margin-top: 20px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
          <p style="margin-top: 10px;">匯入中，請稍候...</p>
        </div>
      </div>
    </div>
  </div>
<!-- 另存新食譜模態窗口 -->
<div class="modal-overlay" id="saveAsModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-copy"></i> 另存新食譜</h3>
      <button class="modal-close" onclick="closeSaveAsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="newRecipeName"><i class="fas fa-pencil-alt"></i> 新食譜名稱</label>
        <input type="text" id="newRecipeName" placeholder="請輸入新食譜名稱..." style="font-size: 1.2rem; padding: 15px;">
      </div>
      
      <div class="info-box">
        <p><i class="fas fa-info-circle"></i> 這將創建當前食譜的一個副本，原食譜保持不變。</p>
      </div>
      
      <div class="btn-group" style="margin-top: 20px;">
        <button class="btn btn-success" onclick="confirmSaveAs()" id="confirmSaveAsBtn">
          <i class="fas fa-check"></i> 確認另存
        </button>
        <button class="btn btn-secondary" onclick="closeSaveAsModal()">
          <i class="fas fa-times"></i> 取消
        </button>
      </div>
    </div>
  </div>
</div>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-utensils"></i> TENG食譜管理系統 v3.1 - 離線版</h1>
      
    </div>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('manage')"><i class="fas fa-edit"></i>食譜管理</div>
      <div class="tab" onclick="switchTab('browse')"><i class="fas fa-book"></i>瀏覽食譜</div>
      <div class="tab" onclick="switchTab('stats')"><i class="fas fa-chart-pie"></i>統計資訊</div>
      <div class="tab" onclick="switchTab('settings')"><i class="fas fa-cog"></i>設定</div>
    </div>

    <div id="manageTab" class="tab-content active">
      <div class="card">
        <div class="card-title"><i class="fas fa-plus-circle"></i><h2>新增 / 修改食譜</h2></div>
        <div class="info-box"><p><i class="fas fa-info-circle"></i> 只有需要計算百分比的分組才必須包含麵粉食材。麵團餡料A和B不需要麵粉但仍會計算百分比。</p></div>
        <div class="form-group"><label for="title"><i class="fas fa-pencil-alt"></i> 食譜名稱</label><input type="text" id="title" placeholder="例如：經典吐司麵包"></div>
        <div class="form-group">
          <label><i class="fas fa-layer-group"></i> 食材分組管理</label>
          <div class="btn-group" style="margin-top:0; margin-bottom: 15px;">
            <button class="btn btn-sm btn-secondary" onclick="addNewGroup()"><i class="fas fa-folder-plus"></i> 新增分組</button>
            <button class="btn btn-sm btn-info" onclick="openConversionModal()" id="conversionToolBtn" style="display: none;">
              <i class="fas fa-calculator"></i> 智能換算工具
            </button>
          </div>
          <div id="ingredients-container"></div>
          <div class="add-ingredient-btn-container">
            <button class="btn btn-info" onclick="addIngredientRow()"><i class="fas fa-plus"></i> 新增食材</button>
            <span id="hydration-display" style="margin-left:10px; font-weight:bold; color:var(--primary-dark)">含水率: 0%</span>
          </div>
        </div>
        <div class="form-group"><label for="steps"><i class="fas fa-list-ol"></i> 製作步驟</label><textarea id="steps" rows="6" placeholder="請詳細描述製作步驟..."></textarea></div>
        
        <div class="form-group">
          <label><i class="fas fa-temperature-high"></i> 烘烤設定</label>
          <div class="baking-grid">
            <div><label for="top-heat">上火溫度 (°C)</label><input type="number" id="top-heat" value="200" step="5"></div>
            <div><label for="bottom-heat">下火溫度 (°C)</label><input type="number" id="bottom-heat" value="200" step="5"></div>
            <div><label for="baking-time">烘烤時間 (min)</label><input type="number" id="baking-time" value="30" step="1" min="0"></div>
          </div>
          <div class="baking-options">
            <div class="checkbox-group"><input type="checkbox" id="convection"><label for="convection">旋風</label></div>
            <div class="checkbox-group"><input type="checkbox" id="steam"><label for="steam">蒸汽</label></div>
          </div>
        </div>
        
        <div class="btn-group">
          <button id="saveBtn" class="btn btn-success" onclick="saveRecipe()"><i class="fas fa-save"></i> 儲存食譜</button>
          <button id="saveAsBtn" class="btn btn-info" onclick="saveAsNewRecipe()" style="display: none;"><i class="fas fa-copy"></i> 另存新食譜</button>
          <button class="btn btn-secondary" onclick="resetForm()"><i class="fas fa-redo"></i> 清除表單</button>
        </div>
      </div>
    </div>

    <div id="browseTab" class="tab-content">
       <div class="card">
        <div class="card-title"><i class="fas fa-book"></i><h2>食譜列表</h2></div>
        <div class="btn-group">
          <button class="btn btn-sm" onclick="loadRecipes()"><i class="fas fa-sync-alt"></i> 重新載入</button>
          <button class="btn btn-sm btn-info" onclick="exportCSV()"><i class="fas fa-file-excel"></i> 匯出 CSV</button>
          <button class="btn btn-sm btn-success" onclick="openImportModal()"><i class="fas fa-file-import"></i> 匯入 CSV</button>
        </div>
        
        <!-- 食譜名稱下拉選單 -->
        <div class="search-filters">
          <label for="recipeFilter">食譜名稱:</label>
          <select id="recipeFilter" onchange="filterByRecipe()">
            <option value="">全部食譜</option>
          </select>
        </div>
        
        <div class="search-container">
          <input type="text" id="searchBar" placeholder="搜尋食譜名稱、食材或步驟..." oninput="filterRecipes()">
          <select id="sortSelect" onchange="applySort()">
            <option value="newest">建立時間 新→舊</option><option value="oldest">建立時間 舊→新</option>
            <option value="az">名稱 A→Z</option><option value="za">名稱 Z→A</option>
          </select>
        </div>
        <div id="recipes-list"></div>
      </div>
    </div>

    <div id="statsTab" class="tab-content">
       <div class="card">
        <div class="card-title"><i class="fas fa-chart-pie"></i><h2>統計資訊</h2></div>
        <div class="stats-container">
          <div class="stat-card"><i class="fas fa-book"></i><h3 id="total-recipes">0</h3><p>食譜總數</p></div>
          <div class="stat-card"><i class="fas fa-list"></i><h3 id="total-ingredients">0</h3><p>食材總數</p></div>
          <div class="stat-card"><i class="fas fa-weight-hanging"></i><h3 id="avg-weight">0</h3><p>平均重量 (g)</p></div>
          <div class="stat-card"><i class="fas fa-clock"></i><h3 id="latest-recipe">-</h3><p>最新食譜</p></div>
        </div>
      </div>
    </div>
    
    <div id="settingsTab" class="tab-content">
      <div class="card">
        <div class="card-title"><i class="fas fa-cogs"></i><h2>自訂食材資料庫</h2></div>
        <div class="info-box"><p><i class="fas fa-info-circle"></i> 在此新增或修改食材的含水率(%)。 [已定義: 水100% 煉乳35% 鮮奶油70% 優格80% 奶油乳酪50% 牛奶90% 雞蛋75% 蜂蜜17%]</p></div>
        <div class="settings-grid">
          <input type="text" id="custom-ingredient-name" placeholder="食材名稱 (例如: 南瓜泥)">
          <input type="number" id="custom-ingredient-hydration" placeholder="含水率 (例如: 85)">
          <button class="btn btn-success" onclick="saveCustomIngredient()"><i class="fas fa-plus"></i> 新增/更新</button>
        </div>
        <div id="custom-ingredients-list" class="custom-ingredients-list"></div>
      </div>
    </div>

    <footer><p>TENG食譜管理系統 v3.1 - 離線版 &copy; 2023-2025 - 專業烘焙食譜管理工具</p></footer>
  </div>

  <div id="saveProgress" class="save-progress"><i class="fas fa-spinner fa-spin"></i><p>儲存中，請稍候...</p></div>
  
  <script>
    // 食材選項
    const baseIngredientOptions = [ "高筋麵粉", "中筋麵粉", "低筋麵粉", "全麥麵粉", "裸麥粉", "麵粉", "水", "牛奶", "糖", "鹽", "蜂蜜", "酵母", "泡打粉", "奶油", "鮮奶油", "奶油乳酪", "奶粉", "煉乳", "雞蛋", "優格", "酒", "香草精" ];
    let ingredientOptions = [];
    
    // 食材含水率對照表
    let hydrationMap = { "水": 1.0, "煉乳": 0.35, "鮮奶油": 0.7, "優格": 0.8, "奶油乳酪": 0.5, "牛奶": 0.9, "雞蛋": 0.75, "蜂蜜": 0.17 };
    
    const groupOptions = [ "主麵團", "麵團餡料A", "麵團餡料B", "波蘭種", "液種", "中種", "魯班種", "內餡", "裝飾", "塔皮", "餅皮", "其他" ];
    const percentageGroups = [ "主麵團", "麵團餡料A", "麵團餡料B", "波蘭種", "液種", "中種", "魯班種" ];
    const flourCheckGroups = [ "主麵團", "波蘭種", "液種", "中種", "魯班種" ];

    let allRecipes = [];
    let editingTitle = null;
    let currentGroups = {};
    let lastUsedGroup = "主麵團";
    
    // 智能換算工具相關變數
    let currentConversionRecipe = null;
    let conversionResults = null;

    // 數據存儲鍵名
    const STORAGE_KEYS = {
      RECIPES: 'teng_recipes',
      INGREDIENTS_DB: 'teng_ingredients_db',
      CUSTOM_INGREDIENTS: 'teng_custom_ingredients'
    };

    // 初始化函數
    function init() {
      // 載入數據
      loadAllData();
      
      // 初始化表單
      addIngredientRow();
      loadRecipes();
      updateStats();
      renderCustomIngredients(getCustomIngredients());
      
      showNotification('離線版系統已載入完成', 'success');
    }

    // 數據存儲函數
    function saveAllData() {
      try {
        localStorage.setItem(STORAGE_KEYS.RECIPES, JSON.stringify(allRecipes));
        localStorage.setItem(STORAGE_KEYS.CUSTOM_INGREDIENTS, JSON.stringify(getCustomIngredients()));
        
        // 更新食材選項
        const customIngredients = getCustomIngredients();
        const customIngredientNames = customIngredients.map(ing => ing.name);
        const uniqueCustomNames = customIngredientNames.filter(name => !baseIngredientOptions.includes(name));
        ingredientOptions = [...baseIngredientOptions, ...uniqueCustomNames];
        
        // 更新含水率映射
        customIngredients.forEach(ing => {
          hydrationMap[ing.name] = parseFloat(ing.hydration) / 100 || 0;
        });
        
        return true;
      } catch (error) {
        console.error('保存數據失敗:', error);
        showNotification('保存數據失敗: ' + error.message, 'error');
        return false;
      }
    }

    function loadAllData() {
      try {
        // 載入食譜
        const recipesData = localStorage.getItem(STORAGE_KEYS.RECIPES);
        if (recipesData) {
          allRecipes = JSON.parse(recipesData);
        }
        
        // 載入自訂食材
        const customIngredientsData = localStorage.getItem(STORAGE_KEYS.CUSTOM_INGREDIENTS);
        if (customIngredientsData) {
          const customIngredients = JSON.parse(customIngredientsData);
          customIngredients.forEach(ing => {
            hydrationMap[ing.name] = parseFloat(ing.hydration) / 100 || 0;
          });
          
          const customIngredientNames = customIngredients.map(ing => ing.name);
          const uniqueCustomNames = customIngredientNames.filter(name => !baseIngredientOptions.includes(name));
          ingredientOptions = [...baseIngredientOptions, ...uniqueCustomNames];
        } else {
          ingredientOptions = [...baseIngredientOptions];
        }
        
        return true;
      } catch (error) {
        console.error('載入數據失敗:', error);
        showNotification('載入數據失敗: ' + error.message, 'error');
        return false;
      }
    }

    function getCustomIngredients() {
      try {
        const data = localStorage.getItem(STORAGE_KEYS.CUSTOM_INGREDIENTS);
        return data ? JSON.parse(data) : [];
      } catch (error) {
        return [];
      }
    }

    // 通知系統函數
    function showNotification(message, type = 'success') {
      const notificationContainer = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      
      let icon = 'fa-check-circle';
      if (type === 'error') icon = 'fa-exclamation-circle';
      if (type === 'warning') icon = 'fa-exclamation-triangle';
      if (type === 'info') icon = 'fa-info-circle';
      
      notification.innerHTML = `
        <i class="fas ${icon} notification-icon"></i>
        <div class="notification-content">${message}</div>
        <button class="notification-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      notificationContainer.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 4000);
    }

    // 頁面切換函數
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');
      
      if (tabName === 'browse') {
        window.scrollTo(0, 0);
      }
      
      if (tabName === 'manage') {
        updateConversionToolButton();
      }
    }

    // 統計資訊更新
    function updateStats() {
      document.getElementById('total-recipes').textContent = allRecipes.length;
      let totalIngredients = 0, totalWeight = 0, latestRecipe = null;
      allRecipes.forEach(recipe => {
        totalIngredients += recipe.ingredients.length;
        recipe.ingredients.forEach(ing => {
          if (percentageGroups.includes(ing.group)) totalWeight += parseFloat(ing.weight) || 0;
        });
        if (!latestRecipe || new Date(recipe.timestamp) > new Date(latestRecipe.timestamp)) latestRecipe = recipe;
      });
      document.getElementById('total-ingredients').textContent = totalIngredients;
      document.getElementById('avg-weight').textContent = allRecipes.length ? (totalWeight / allRecipes.length).toFixed(0) : 0;
      document.getElementById('latest-recipe').textContent = latestRecipe ? latestRecipe.title : '-';
    }

    // 分組管理
    function addNewGroup() {
      const groupName = prompt("請輸入新分組名稱：");
      if (groupName && groupName.trim() !== "") {
        if (!groupOptions.includes(groupName)) groupOptions.push(groupName);
        addIngredientRow("", "", "", "", groupName);
        showNotification(`已新增分組: ${groupName}`, 'success');
      }
    }

    // 麵粉識別
    function isFlour(name) {
      if (!name) return false;
      const flourKeywords = [ "高筋麵粉", "中筋麵粉", "低筋麵粉", "全麥麵粉", "裸麥粉", "麵粉" ];
      return flourKeywords.some(keyword => name === keyword);
    }

    // 含水率計算
    function calcHydration() {
      const rows = document.querySelectorAll(".ingredient-grid");
      let totalFlour = 0, totalWater = 0;
      rows.forEach(row => {
        const group = row.children[0].value;
        if (!percentageGroups.includes(group)) return;

        const foodName = row.children[1].value;
        const weight = parseFloat(row.children[2].value) || 0;
        if (isFlour(foodName)) totalFlour += weight;

        const factor = hydrationMap[foodName] !== undefined ? hydrationMap[foodName] : 0;
        totalWater += weight * factor;
      });
      const hydration = totalFlour > 0 ? (totalWater / totalFlour * 100).toFixed(1) : 0;
      const displayEl = document.getElementById("hydration-display");
      if (displayEl) displayEl.textContent = `含水率: ${hydration}%`;
    }

    // 添加食材行
    function addIngredientRow(nameVal = "", weightVal = "", percentVal = "", descVal = "", groupVal = lastUsedGroup) {
        const container = document.getElementById("ingredients-container");
        if (!currentGroups[groupVal]) {
            currentGroups[groupVal] = true;
            const groupHeader = document.createElement("div");
            groupHeader.className = "ingredient-group-header";
            groupHeader.innerHTML = `<span>${groupVal} 分組</span><span class="flour-warning" id="warning-${groupVal.replace(/\s+/g, '-')}"><i class="fas fa-exclamation-circle"></i> 此分組需要至少一種麵粉食材</span>`;
            container.appendChild(groupHeader);
            document.getElementById(`warning-${groupVal.replace(/\s+/g, "-")}`).style.display = flourCheckGroups.includes(groupVal) ? "block" : "none";
        }
        const row = document.createElement("div");
        row.className = "ingredient-grid";

        // 分組
        const groupSelect = document.createElement("select");
        groupSelect.innerHTML = groupOptions.map(g => `<option value="${g}" ${g === groupVal ? "selected" : ""}>${g}</option>`).join("");
        groupSelect.addEventListener("change", function() { 
          lastUsedGroup = this.value; 
          updateGroupHeaders(); 
          calcPercentages(); 
          calcHydration(); 
        });

        // 食材名稱
        const nameSelect = document.createElement("select");
        nameSelect.innerHTML = "<option value=''>選擇食材</option>" + ingredientOptions.map(o => `<option value="${o}">${o}</option>`).join("");
        if (nameVal) nameSelect.value = nameVal;
        nameSelect.addEventListener("change", function() { 
          calcPercentages(); 
          calcHydration(); 
        });
        
        const weightInput = document.createElement("input");
        weightInput.type = "number"; 
        weightInput.placeholder = "重量 (g)"; 
        weightInput.min = "0"; 
        weightInput.step = "1";
        if (weightVal !== "" && weightVal !== undefined) weightInput.value = weightVal;
        weightInput.addEventListener("input", () => { 
          calcPercentages(); 
          calcHydration(); 
        });
        
        const percentInput = document.createElement("input");
        percentInput.placeholder = "百分比"; 
        percentInput.readOnly = true;
        if (percentVal) percentInput.value = formatPercentFrontend(percentVal);
        
        const descInput = document.createElement("input");
        descInput.placeholder = "說明 (可選)";
        if (descVal) descInput.value = descVal;

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-danger btn-sm"; 
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = function() { 
          row.remove(); 
          updateGroupHeaders(); 
          calcPercentages(); 
          calcHydration(); 
          showNotification('已移除食材', 'info');
        };

        [groupSelect, nameSelect, weightInput, percentInput, descInput, deleteBtn].forEach(el => row.appendChild(el));
        container.appendChild(row);
        calcPercentages(); 
        calcHydration();
        
        updateConversionToolButton();
    }

    function updateGroupHeaders() {
      const container = document.getElementById("ingredients-container");
      const headers = container.querySelectorAll(".ingredient-group-header");
      const rows = container.querySelectorAll(".ingredient-grid");
      
      const groupCounts = {};
      rows.forEach(row => {
        const group = row.children[0].value;
        groupCounts[group] = (groupCounts[group] || 0) + 1;
      });
      
      headers.forEach(header => {
        const groupName = header.querySelector("span").textContent.replace(" 分組", "");
        if (!groupCounts[groupName]) {
          header.remove();
          delete currentGroups[groupName];
        }
      });
      
      updateConversionToolButton();
    }

    // 百分比計算
    function calcPercentages() {
      const rows = document.querySelectorAll(".ingredient-grid");
      
      let totalFlourWeight = 0;
      rows.forEach(row => {
        const group = row.children[0].value;
        if (percentageGroups.includes(group)) {
          const foodName = row.children[1].value;
          const weight = parseFloat(row.children[2].value) || 0;
          if (isFlour(foodName)) {
            totalFlourWeight += weight;
          }
        }
      });
      
      rows.forEach(row => {
        const group = row.children[0].value;
        const weight = parseFloat(row.children[2].value) || 0;
        const percentInput = row.children[3];
        
        if (percentageGroups.includes(group)) {
          if (totalFlourWeight > 0) {
            const percent = (weight / totalFlourWeight) * 100;
            percentInput.value = formatPercentDisplay(percent);
          } else {
            percentInput.value = "";
          }
        } else {
          percentInput.value = "";
        }
      });
    }

// 百分比顯示格式化
function formatPercentDisplay(value) {
  if (value === '' || value === null || value === undefined) return '';
  
  let numericValue;
  if (typeof value === 'string') {
    // 如果是百分比字符串，去掉百分號轉為數字
    if (value.includes('%')) {
      numericValue = parseFloat(value.replace('%', ''));
    } else {
      numericValue = parseFloat(value);
    }
  } else {
    numericValue = value;
  }
  
  if (isNaN(numericValue)) return '';
  
  // 將小數轉換為百分比顯示
  const percentValue = numericValue * 100;
  let formatted = parseFloat(percentValue.toFixed(10)).toString();
  
  if (formatted.indexOf('.') !== -1) {
    formatted = formatted.replace(/\.?0+$/, '');
  }
  
  return formatted + '%';
}

function formatPercentFrontend(p) {
  if (!p) return '';
  if (typeof p === 'string' && p.includes('%')) {
    return p;
  }
  
  const numValue = parseFloat(p);
  if (isNaN(numValue)) return '';
  
  return formatPercentDisplay(numValue);
}

    // HTML 轉義
    function escapeHtml(s) { 
      return s ? String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : ""; 
    }
    
    // 進度顯示
    function showSaveProgress() { document.getElementById('saveProgress').style.display = 'block'; }
    function hideSaveProgress() { document.getElementById('saveProgress').style.display = 'none'; }

    // 保存食譜
    function saveRecipe() {
      const title = document.getElementById("title").value.trim();
      const steps = document.getElementById("steps").value.trim();
      
      const bakingInfo = {
        topHeat: document.getElementById('top-heat').value, 
        bottomHeat: document.getElementById('bottom-heat').value,
        time: document.getElementById('baking-time').value, 
        convection: document.getElementById('convection').checked,
        steam: document.getElementById('steam').checked
      };

      const rows = document.querySelectorAll(".ingredient-grid");
      const ingredients = [];
      showSaveProgress();

      // 檢查需要麵粉的分組是否有麵粉
      const missingFlourGroups = [];
      const groups = {};
      
      rows.forEach(row => {
        const group = row.children[0].value;
        if (!groups[group]) groups[group] = { hasFlour: false, ingredients: [] };
        
        const foodName = row.children[1].value;
        if (isFlour(foodName)) {
          groups[group].hasFlour = true;
        }
      });
      
      flourCheckGroups.forEach(group => {
        if (groups[group] && !groups[group].hasFlour) {
          missingFlourGroups.push(group);
        }
      });
      
      if (missingFlourGroups.length > 0) {
        hideSaveProgress();
        showNotification(`以下分組必須至少包含一種麵粉食材：${missingFlourGroups.join("、")}`, 'error');
        return;
      }
      
// 在 saveRecipe 和 saveAsNewRecipe 函數中，修改百分比處理部分：

rows.forEach(row => {
  const foodName = row.children[1].value;
  if (!foodName) return;
  
  const percentValue = row.children[3].value || "";
  let percentNum = "";
  
  if (percentValue && percentValue !== "-") {
    const cleanValue = percentValue.replace("%", "");
    const numericValue = parseFloat(cleanValue);
    // 將百分比轉換為小數儲存
    percentNum = !isNaN(numericValue) ? (numericValue / 100) : "";
  }
  
  currentIngredients.push({
    group: row.children[0].value, 
    name: foodName, 
    weight: parseFloat(row.children[2].value) || 0,
    percent: percentNum, 
    desc: row.children[4].value.trim()
  });
});

      if (!title || !steps || ingredients.length === 0) { 
        hideSaveProgress(); 
        showNotification("請完整填寫食譜名稱、步驟與至少一個食材", 'error'); 
        return; 
      }

      // 檢查食譜名稱是否已存在（新增時）
      if (!editingTitle && allRecipes.some(recipe => recipe.title === title)) {
        hideSaveProgress();
        showNotification("食譜名稱已存在，請使用其他名稱", 'error');
        return;
      }

      const timestamp = new Date().toISOString();
      const recipeData = {
        title: title,
        ingredients: ingredients,
        steps: steps,
        timestamp: timestamp,
        baking: bakingInfo
      };

      if (editingTitle) {
        // 更新現有食譜
        const index = allRecipes.findIndex(recipe => recipe.title === editingTitle);
        if (index !== -1) {
          allRecipes[index] = recipeData;
          showNotification(`已更新食譜: ${title}`, 'success');
        }
      } else {
        // 新增食譜
        allRecipes.push(recipeData);
        showNotification(`已新增食譜: ${title}`, 'success');
      }

      // 保存數據
      if (saveAllData()) {
        resetForm();
        loadRecipes();
        switchTab("browse");
        
        setTimeout(() => {
          window.scrollTo(0, 0);
        }, 100);
      }
      
      hideSaveProgress();
    }

    // 另存新食譜
// 打開另存新食譜模態窗口
function saveAsNewRecipe() {
  if (!editingTitle) {
    showNotification('請先載入要複製的食譜', 'error');
    return;
  }
  
  // 設置預設名稱
  const defaultName = editingTitle + ' - 副本';
  document.getElementById('newRecipeName').value = defaultName;
  
  // 清空之前的錯誤狀態
  document.getElementById('newRecipeName').classList.remove('error');
  
  // 顯示模態窗口
  document.getElementById('saveAsModal').classList.add('active');
  
  // 聚焦到輸入框並選擇文本
  setTimeout(() => {
    const input = document.getElementById('newRecipeName');
    input.focus();
    input.select();
  }, 300);
}

// 關閉另存新食譜模態窗口
function closeSaveAsModal() {
  document.getElementById('saveAsModal').classList.remove('active');
}

// 確認另存新食譜
function confirmSaveAs() {
  const newTitle = document.getElementById('newRecipeName').value.trim();
  const inputElement = document.getElementById('newRecipeName');
  
  // 驗證輸入
  if (!newTitle) {
    inputElement.classList.add('error');
    showNotification('新食譜名稱不能為空', 'error');
    return;
  }
  
  // 檢查食譜名稱是否已存在
  if (allRecipes.some(recipe => recipe.title === newTitle)) {
    inputElement.classList.add('error');
    showNotification('食譜名稱已存在，請使用其他名稱', 'error');
    return;
  }
  
  // 移除錯誤狀態
  inputElement.classList.remove('error');
  
  // 禁用按鈕避免重複點擊
  const confirmBtn = document.getElementById('confirmSaveAsBtn');
  confirmBtn.disabled = true;
  confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
  
  // 收集當前表單數據
  const currentTitle = document.getElementById("title").value;
  const currentSteps = document.getElementById("steps").value;
  const currentBakingInfo = {
    topHeat: document.getElementById('top-heat').value, 
    bottomHeat: document.getElementById('bottom-heat').value,
    time: document.getElementById('baking-time').value, 
    convection: document.getElementById('convection').checked,
    steam: document.getElementById('steam').checked
  };
  
  const rows = document.querySelectorAll(".ingredient-grid");
  const currentIngredients = [];
  
// 在 saveRecipe 和 saveAsNewRecipe 函數中，修改百分比處理部分：

rows.forEach(row => {
  const foodName = row.children[1].value;
  if (!foodName) return;
  
  const percentValue = row.children[3].value || "";
  let percentNum = "";
  
  if (percentValue && percentValue !== "-") {
    const cleanValue = percentValue.replace("%", "");
    const numericValue = parseFloat(cleanValue);
    // 將百分比轉換為小數儲存
    percentNum = !isNaN(numericValue) ? (numericValue / 100) : "";
  }
  
  currentIngredients.push({
    group: row.children[0].value, 
    name: foodName, 
    weight: parseFloat(row.children[2].value) || 0,
    percent: percentNum, 
    desc: row.children[4].value.trim()
  });
});
  
  showSaveProgress();
  
  const timestamp = new Date().toISOString();
  const recipeData = {
    title: newTitle,
    ingredients: currentIngredients,
    steps: currentSteps,
    timestamp: timestamp,
    baking: currentBakingInfo
  };

  allRecipes.push(recipeData);
  
  if (saveAllData()) {
    showNotification(`已另存新食譜: ${newTitle}`, 'success');
    
    // 關閉模態窗口
    closeSaveAsModal();
    
    // 重置表單狀態
    editingTitle = null;
    document.getElementById("saveBtn").innerHTML = '<i class="fas fa-save"></i> 儲存食譜';
    document.getElementById("saveBtn").onclick = saveRecipe;
    document.getElementById("saveAsBtn").style.display = 'none';
    
    // 更新表單中的食譜名稱
    document.getElementById("title").value = newTitle;
    
    // 重新載入食譜列表
    loadRecipes();
    switchTab("browse");
    
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 100);
  }
  
  hideSaveProgress();
  
  // 重新啟用按鈕
  setTimeout(() => {
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = '<i class="fas fa-check"></i> 確認另存';
  }, 1000);
}

// 為輸入框添加 Enter 鍵支持
document.addEventListener('DOMContentLoaded', function() {
  const newRecipeNameInput = document.getElementById('newRecipeName');
  if (newRecipeNameInput) {
    newRecipeNameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        confirmSaveAs();
      }
    });
  }
});
    // 重置表單
    function resetForm() {
      editingTitle = null;
      document.getElementById("title").value = "";
      document.getElementById("steps").value = "";
      document.getElementById("ingredients-container").innerHTML = "";
      currentGroups = {};
      
      document.getElementById('top-heat').value = 200;
      document.getElementById('bottom-heat').value = 200;
      document.getElementById('baking-time').value = 30;
      document.getElementById('convection').checked = false;
      document.getElementById('steam').checked = false;

      const btn = document.getElementById("saveBtn");
      btn.innerHTML = '<i class="fas fa-save"></i> 儲存食譜';
      btn.onclick = saveRecipe;
      document.getElementById("saveAsBtn").style.display = 'none';
      
      addIngredientRow();
    }

    // 載入食譜列表
    function loadRecipes() {
      allRecipes = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECIPES) || []).filter(r => r && r.title && r.title.toString().trim() !== "食譜名稱");
      applySort();
      updateStats();
      updateRecipeFilter(allRecipes);
    }

    // 更新食譜名稱下拉選單
    function updateRecipeFilter(recipesToShow = allRecipes) {
      const recipeFilter = document.getElementById("recipeFilter");
      const currentValue = recipeFilter.value;
      
 // 確保傳入是陣列並過濾不合法項
  if (!Array.isArray(recipesToShow)) recipesToShow = [];
  const validRecipes = recipesToShow.filter(r => r && r.title && r.title.toString().trim() !== "食譜名稱");

  // 清空現有選項（保留"全部食譜"選項）
  if (recipeFilter) {
    while (recipeFilter.options.length > 1) {
      recipeFilter.remove(1);
    }
  } else {
    return;
  }
      
      const recipeNames = [...new Set(recipesToShow.map(recipe => recipe.title))];
      recipeNames.sort((a, b) => a.localeCompare(b, 'zh-Hant'));
      
      recipeNames.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        recipeFilter.appendChild(option);
      });
      
      if (currentValue && recipeNames.includes(currentValue)) {
        recipeFilter.value = currentValue;
      } else {
        recipeFilter.value = "";
      }
    }

    // 根據食譜名稱篩選
    function filterByRecipe() {
      filterRecipes();
    }

    // 解析食譜時間
    function parseRecipeTime(recipe) { 
      if (!recipe.timestamp) return 0;
      return new Date(recipe.timestamp.replace(/上午|下午/, ' ')).getTime() || 0; 
    }

    // 渲染食譜列表
    function renderRecipes(recipes) {
        const container = document.getElementById("recipes-list");
        container.innerHTML = "";
        if (!recipes || !recipes.length) {
            container.innerHTML = `<div class="empty-state"><i class="fas fa-book-open"></i><h3>尚未建立任何食譜</h3><p>點擊「食譜管理」開始建立您的第一個食譜</p></div>`;
            return;
        }
        recipes.forEach(recipe => {
            let totalWeight = 0, totalFlour = 0, totalWater = 0;
            recipe.ingredients.forEach(ing => {
                if (percentageGroups.includes(ing.group)) {
                    const w = parseFloat(ing.weight) || 0;
                    totalWeight += w;
                    if (isFlour(ing.name)) totalFlour += w;
                    const factor = hydrationMap[ing.name] !== undefined ? hydrationMap[ing.name] : 0;
                    totalWater += w * factor;
                }
            });
            const hydration = totalFlour > 0 ? (totalWater / totalFlour * 100).toFixed(1) : 0;
            const groupedIngredients = {};
            recipe.ingredients.forEach(ing => {
                if (!groupedIngredients[ing.group]) groupedIngredients[ing.group] = [];
                groupedIngredients[ing.group].push(ing);
            });
            let ingredientsHtml = "";
            Object.keys(groupedIngredients).forEach(group => {
                ingredientsHtml += `<tr class="ingredient-group-row"><td colspan="4"><span class="group-badge">${group}</span> 分組食材</td></tr>`;
                groupedIngredients[group].forEach(ing => {
                    const percentDisplay = formatPercentFrontend(ing.percent);
                    ingredientsHtml += `<tr><td class="checkbox-cell"><input type="checkbox"></td><td>${escapeHtml(ing.name)}</td><td>${escapeHtml(ing.weight)}g</td><td>${percentageGroups.includes(group) ? escapeHtml(percentDisplay) : "-"}</td><td>${escapeHtml(ing.desc || "-")}</td></tr>`;
                });
            });
            
            const baking = recipe.baking || {};
            const recipeEl = document.createElement("div");
            recipeEl.className = "recipe-card";
            recipeEl.innerHTML = `
                <div class="recipe-header">
                    <div><div class="recipe-title">${escapeHtml(recipe.title)}</div><div class="recipe-meta">建立時間: ${escapeHtml(recipe.timestamp || "-")}</div></div>
                    <div class="recipe-meta">總重量: ${totalWeight.toFixed(2)}g<br>含水率: ${hydration}%</div>
                </div>
                <table class="ingredient-table"><thead><tr><th class="checkbox-cell"></th><th>食材</th><th>重量</th><th>百分比</th><th>說明</th></tr></thead><tbody>${ingredientsHtml}</tbody></table>
                <div class="steps-container"><strong>步驟:</strong><div>${escapeHtml(recipe.steps || "-").replace(/\n/g, "<br>")}</div></div>
                <div class="baking-container"><strong>烘烤設定:</strong><div>上火: ${baking.topHeat || 200}°C | 下火: ${baking.bottomHeat || 200}°C | 時間: ${baking.time || 30} 分 | 旋風: ${baking.convection ? '是' : '否'} | 蒸汽: ${baking.steam ? '是' : '否'}</div></div>
                <div class="action-buttons">
                  <button class="btn btn-warning btn-sm edit-btn"><i class="fas fa-edit"></i> 編輯</button>
                  <button class="btn btn-danger btn-sm delete-btn"><i class="fas fa-trash"></i> 刪除</button>
                  <button class="btn btn-info btn-sm convert-btn"><i class="fas fa-calculator"></i> 智能換算</button>
                  <button class="btn btn-primary btn-sm timer-btn"><i class="fas fa-clock"></i> 食譜計時器</button>
                </div>
            `;
            recipeEl.querySelector(".edit-btn").addEventListener("click", () => editRecipe(recipe.title));
            recipeEl.querySelector(".delete-btn").addEventListener("click", () => deleteRecipe(recipe.title));
            recipeEl.querySelector(".convert-btn").addEventListener("click", () => openConversionModal(recipe.title));
            recipeEl.querySelector(".timer-btn").addEventListener("click", () => openRecipeTimer(recipe));
            container.appendChild(recipeEl);
        });
    }

    // 編輯食譜
    function editRecipe(title) {
        const recipe = allRecipes.find(r => r.title === title);
        if (!recipe) { 
          showNotification("找不到食譜: " + title, 'error'); 
          return; 
        }
        editingTitle = title;
        document.getElementById("title").value = recipe.title;
        document.getElementById("steps").value = recipe.steps || "";
        const container = document.getElementById("ingredients-container");
        container.innerHTML = ""; 
        currentGroups = {};
        
        const baking = recipe.baking || {};
        document.getElementById('top-heat').value = baking.topHeat || 200;
        document.getElementById('bottom-heat').value = baking.bottomHeat || 200;
        document.getElementById('baking-time').value = baking.time || 30;
        document.getElementById('convection').checked = baking.convection || false;
        document.getElementById('steam').checked = baking.steam || false;
        
        (recipe.ingredients || []).forEach(ing => {
            const percentDisplay = formatPercentFrontend(ing.percent);
            addIngredientRow(ing.name, ing.weight, percentDisplay, ing.desc, ing.group);
            lastUsedGroup = ing.group;
        });

        const btn = document.getElementById("saveBtn");
        btn.innerHTML = '<i class="fas fa-save"></i> 更新食譜';
        btn.onclick = saveRecipe;
        document.getElementById("saveAsBtn").style.display = 'inline-flex';
        
        switchTab("manage");
        showNotification(`已載入食譜: ${title}`, 'info');
        
        updateConversionToolButton();
    }

    // 刪除食譜
    function deleteRecipe(title) {
      if (!confirm(`確定要刪除「${title}」嗎？此操作無法還原。`)) return;
      
      const index = allRecipes.findIndex(recipe => recipe.title === title);
      if (index !== -1) {
        allRecipes.splice(index, 1);
        if (saveAllData()) {
          showNotification(`已刪除食譜: ${title}`, 'success');
          loadRecipes();
        }
      }
    }

    // 篩選食譜
    function filterRecipes(doRender = true) {
      const q = document.getElementById("searchBar").value.toLowerCase();
      const selectedRecipe = document.getElementById("recipeFilter").value;
      
      let f = allRecipes;
      
      if (selectedRecipe) {
        f = f.filter(r => r.title === selectedRecipe);
      }
      
      if (q) {
        f = f.filter(r => 
          r.title.toLowerCase().includes(q) || 
          (r.steps || "").toLowerCase().includes(q) || 
          (r.ingredients || []).some(i => i.name.toLowerCase().includes(q))
        );
      }
      
      if (q) {
        updateRecipeFilter(f);
      } else {
        updateRecipeFilter(allRecipes);
      }
      
      if (doRender) renderRecipes(f);
      return f;
    }

    // 排序食譜
    function applySort() { 
      const v = document.getElementById("sortSelect").value; 
      let f = filterRecipes(false); 
      if (v === "newest") f.sort((a, b) => parseRecipeTime(b) - parseRecipeTime(a)); 
      else if (v === "oldest") f.sort((a, b) => parseRecipeTime(a) - parseRecipeTime(b)); 
      else if (v === "az") f.sort((a, b) => a.title.localeCompare(b.title, "zh-Hant")); 
      else if (v === "za") f.sort((a, b) => b.title.localeCompare(a.title, "zh-Hant")); 
      renderRecipes(f); 
    }
    
    // 匯出 CSV
// 匯出 CSV
function exportCSV() {
    if (!allRecipes.length) { 
      showNotification("沒有資料可匯出", 'warning'); 
      return; 
    }
    
    let csvContent = "=== 食譜數據 ===\n";
    csvContent += "食譜名稱,分組,食材,重量 (g),百分比,說明,步驟,建立時間,上火溫度,下火溫度,烘烤時間,旋風,蒸汽\n";
    
    allRecipes.forEach(recipe => {
        const baking = recipe.baking || {};
        recipe.ingredients.forEach(ing => {
            // 修復百分比格式：確保匯出時是小數格式，而不是百分比字符串
            const percentValue = ing.percent ? parseFloat(ing.percent) : '';
            
            const stepsEscaped = (recipe.steps || '').replace(/\n/g, '[[NEWLINE]]').replace(/"/g, '""');
            const descEscaped = (ing.desc || '').replace(/"/g, '""');
            
            csvContent += `"${recipe.title}","${ing.group}","${ing.name}",${ing.weight},${percentValue},"${descEscaped}","${stepsEscaped}",${recipe.timestamp},${baking.topHeat || ''},${baking.bottomHeat || ''},${baking.time || ''},${baking.convection ? '是':'否'},${baking.steam ? '是':'否'}\n`;
        });
    });
    
    csvContent += "\n=== 食材資料庫 ===\n";
    csvContent += "食材名稱,含水率\n";
    
    const customIngredients = getCustomIngredients();
    customIngredients.forEach(ing => {
        csvContent += `"${ing.name}",${ing.hydration}\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const fileName = "食譜備份_" + new Date().toISOString().slice(0,10).replace(/-/g, "") + ".csv";
    
    link.setAttribute('href', url);
    link.setAttribute('download', fileName);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
    
    showNotification('CSV 檔案已匯出', 'success');
}

    // 匯入 CSV
    function importCSV() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showNotification('請選擇要匯入的 CSV 檔案', 'error');
        return;
      }
      
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showNotification('請選擇 CSV 檔案', 'error');
        return;
      }
      
      const progressElement = document.getElementById('importProgress');
      const importBtn = document.getElementById('importBtn');
      progressElement.style.display = 'block';
      importBtn.disabled = true;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const csvContent = e.target.result;
        
        const timeoutId = setTimeout(() => {
          progressElement.style.display = 'none';
          importBtn.disabled = false;
          showNotification('匯入超時，請稍後再試', 'error');
        }, 15000);
        
        try {
          const result = parseCSVData(csvContent);
          clearTimeout(timeoutId);
          progressElement.style.display = 'none';
          importBtn.disabled = false;
          
          if (result.status === 'success') {
            showNotification(result.message, 'success');
            closeImportModal();
            loadRecipes();
            init();
          } else {
            showNotification(result.message, 'error');
          }
        } catch (error) {
          clearTimeout(timeoutId);
          progressElement.style.display = 'none';
          importBtn.disabled = false;
          showNotification('匯入失敗: ' + error.message, 'error');
        }
      };
      
      reader.onerror = function() {
        progressElement.style.display = 'none';
        importBtn.disabled = false;
        showNotification('讀取檔案失敗', 'error');
      };
      
      reader.readAsText(file, 'UTF-8');
    }

    // 解析 CSV 數據
// 解析 CSV 數據
function parseCSVData(csvContent) {
  try {
    const lines = csvContent.split('\n');
    let currentSection = '';
    const recipesMap = new Map();
    const customIngredients = [];
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();
      
      if (line === '=== 食譜數據 ===') {
        currentSection = 'recipes';
        continue;
      } else if (line === '=== 食材資料庫 ===') {
        currentSection = 'ingredients';
        continue;
      }
      
      if (line === '' || line.startsWith('===')) continue;
      
      if (currentSection === 'recipes' && i > 0) { // 跳過表頭
        const row = parseCSVLine(line);
        if (row.length >= 8) {
          const recipeName = row[0].replace(/^"|"$/g, '');
          if (!recipesMap.has(recipeName)) {
            recipesMap.set(recipeName, {
              title: recipeName,
              ingredients: [],
              steps: row[6].replace(/^"|"$/g, '').replace(/\[\[NEWLINE\]\]/g, '\n'),
              timestamp: row[7],
              baking: {
                topHeat: row[8] || 200,
                bottomHeat: row[9] || 200,
                time: row[10] || 30,
                convection: row[11] === '是',
                steam: row[12] === '是'
              }
            });
          }
          
          const recipe = recipesMap.get(recipeName);
          
          // 修復百分比處理
          let percentValue = '';
          const percentCell = row[4] ? row[4].replace(/^"|"$/g, '') : '';
          
          if (percentCell) {
            if (percentCell.includes('%')) {
              // 如果已經是百分比格式 (如 "75%"), 轉換為小數
              const percentNumber = parseFloat(percentCell.replace('%', ''));
              percentValue = !isNaN(percentNumber) ? (percentNumber / 100) : '';
            } else {
              // 如果是小數格式 (如 "0.75"), 直接使用
              const decimalValue = parseFloat(percentCell);
              percentValue = !isNaN(decimalValue) ? decimalValue : '';
            }
          }
          
          recipe.ingredients.push({
            group: row[1].replace(/^"|"$/g, ''),
            name: row[2].replace(/^"|"$/g, ''),
            weight: parseFloat(row[3]) || 0,
            percent: percentValue,
            desc: row[5].replace(/^"|"$/g, '')
          });
        }
      } else if (currentSection === 'ingredients' && i > 0) { // 跳過表頭
        const row = parseCSVLine(line);
        if (row.length >= 2) {
          customIngredients.push({
            name: row[0].replace(/^"|"$/g, ''),
            hydration: parseFloat(row[1]) || 0
          });
        }
      }
    }
    
    // 保存數據
    allRecipes = Array.from(recipesMap.values());
    localStorage.setItem(STORAGE_KEYS.RECIPES, JSON.stringify(allRecipes));
    localStorage.setItem(STORAGE_KEYS.CUSTOM_INGREDIENTS, JSON.stringify(customIngredients));
    
    return {
      status: "success",
      message: `成功匯入 ${recipesMap.size} 筆食譜數據和 ${customIngredients.length} 筆食材數據`,
      counts: {
        recipes: recipesMap.size,
        ingredients: customIngredients.length
      }
    };
    
  } catch (error) {
    return {
      status: "error",
      message: "CSV 解析失敗: " + error.message
    };
  }
}
    // 解析 CSV 行
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      let quoteChar = '';
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (inQuotes) {
          if (char === quoteChar) {
            if (i + 1 < line.length && line[i + 1] === quoteChar) {
              current += quoteChar;
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            current += char;
          }
        } else {
          if (char === '"' || char === "'") {
            inQuotes = true;
            quoteChar = char;
          } else if (char === ',') {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
      }
      
      result.push(current);
      return result;
    }

    // 自訂食材管理
    function renderCustomIngredients(ingredients) {
      const container = document.getElementById('custom-ingredients-list');
      container.innerHTML = `<h4>現有自訂食材</h4>`;
      
      if (!ingredients || ingredients.length === 0) {
        container.innerHTML += `<p>尚未添加任何自訂食材</p>`;
        return;
      }
      
      const list = document.createElement('ul');
      ingredients.forEach(ing => {
        const item = document.createElement('li');
        item.innerHTML = `
          <div class="ingredient-info">${ing.name}: ${ing.hydration}%</div>
          <div class="ingredient-actions">
            <button class="btn btn-sm btn-danger" onclick="deleteCustomIngredient('${ing.name.replace(/'/g, "\\'")}')">
              <i class="fas fa-trash"></i> 刪除
            </button>
          </div>
        `;
        list.appendChild(item);
      });
      container.appendChild(list);
    }
    
    function saveCustomIngredient() {
        const name = document.getElementById('custom-ingredient-name').value.trim();
        const hydration = parseFloat(document.getElementById('custom-ingredient-hydration').value);
        if (!name || isNaN(hydration)) {
            showNotification('請輸入有效的食材名稱與含水率', 'error');
            return;
        }
        
        const customIngredients = getCustomIngredients();
        const existingIndex = customIngredients.findIndex(ing => ing.name === name);
        
        if (existingIndex !== -1) {
            customIngredients[existingIndex].hydration = hydration;
        } else {
            customIngredients.push({ name, hydration });
        }
        
        localStorage.setItem(STORAGE_KEYS.CUSTOM_INGREDIENTS, JSON.stringify(customIngredients));
        showNotification(`已${existingIndex !== -1 ? '更新' : '新增'}食材: ${name}`, 'success');
        
        document.getElementById('custom-ingredient-name').value = '';
        document.getElementById('custom-ingredient-hydration').value = '';
        
        // 重新初始化以更新食材選項
        init();
    }

    function deleteCustomIngredient(name) {
      if (!confirm(`確定要刪除「${name}」嗎？`)) return;
      
      const customIngredients = getCustomIngredients();
      const filtered = customIngredients.filter(ing => ing.name !== name);
      
      localStorage.setItem(STORAGE_KEYS.CUSTOM_INGREDIENTS, JSON.stringify(filtered));
      showNotification(`已刪除食材: ${name}`, 'success');
      
      // 重新初始化以更新食材選項
      init();
    }

    // 智能換算工具相關函數
    function updateConversionToolButton() {
      const btn = document.getElementById('conversionToolBtn');
      const rows = document.querySelectorAll(".ingredient-grid");
      
      if (editingTitle && rows.length > 0) {
        btn.style.display = 'inline-flex';
      } else {
        btn.style.display = 'none';
      }
    }

    function openConversionModal(recipeTitle = null) {
      currentConversionRecipe = recipeTitle || editingTitle;
      
      if (!currentConversionRecipe) {
        showNotification('請先選擇或編輯一個食譜', 'warning');
        return;
      }
      
      let originalTotalFlour = 0;
      if (recipeTitle) {
        const recipe = allRecipes.find(r => r.title === recipeTitle);
        if (recipe) {
          recipe.ingredients.forEach(ing => {
            if (isFlour(ing.name) && percentageGroups.includes(ing.group)) {
              originalTotalFlour += parseFloat(ing.weight) || 0;
            }
          });
        }
      } else {
        const rows = document.querySelectorAll(".ingredient-grid");
        rows.forEach(row => {
          const group = row.children[0].value;
          const foodName = row.children[1].value;
          const weight = parseFloat(row.children[2].value) || 0;
          
          if (isFlour(foodName) && percentageGroups.includes(group)) {
            originalTotalFlour += weight;
          }
        });
      }
      
      if (originalTotalFlour <= 0) {
        showNotification('此食譜沒有麵粉食材或麵粉重量為0', 'error');
        return;
      }
      
      document.getElementById('originalFlour').value = originalTotalFlour.toFixed(1);
      document.getElementById('newFlour').value = originalTotalFlour.toFixed(1);
      document.getElementById('conversionRatio').value = '1.0';
      
      document.querySelectorAll('.conversion-option-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-ratio') === '1') {
          btn.classList.add('active');
        }
      });
      
      document.getElementById('includeNonPercentage').checked = false;
      document.getElementById('conversionResults').style.display = 'none';
      
      document.getElementById('conversionModal').classList.add('active');
    }

    function closeConversionModal() {
      document.getElementById('conversionModal').classList.remove('active');
      currentConversionRecipe = null;
      conversionResults = null;
    }

    function calculateConversion() {
      const originalFlour = parseFloat(document.getElementById('originalFlour').value);
      const newFlourInput = document.getElementById('newFlour').value;
      const includeNonPercentage = document.getElementById('includeNonPercentage').checked;
      
      const newFlour = parseFloat(newFlourInput);
      
      if (!newFlour || newFlour <= 0) {
        showNotification('請輸入有效的新麵粉量', 'error');
        return;
      }
      
      const conversionRatio = newFlour / originalFlour;
      document.getElementById('conversionRatio').value = conversionRatio.toFixed(3);
      
      if (currentConversionRecipe === editingTitle) {
        calculateConversionFromForm(conversionRatio, includeNonPercentage);
      } else {
        calculateConversionFromRecipe(currentConversionRecipe, conversionRatio, includeNonPercentage);
      }
    }

    function calculateConversionFromForm(conversionRatio, includeNonPercentage) {
      const rows = document.querySelectorAll(".ingredient-grid");
      const convertedIngredients = [];
      
      rows.forEach(row => {
        const group = row.children[0].value;
        const name = row.children[1].value;
        const originalWeight = parseFloat(row.children[2].value) || 0;
        const percent = row.children[3].value;
        const desc = row.children[4].value;
        
        let newWeight = originalWeight;
        if (percentageGroups.includes(group) || includeNonPercentage) {
          newWeight = originalWeight * conversionRatio;
        }
        
        convertedIngredients.push({
          group: group,
          name: name,
          weight: newWeight,
          originalWeight: originalWeight,
          percent: percent,
          desc: desc
        });
      });
      
      let originalTotalFlour = 0;
      rows.forEach(row => {
        const group = row.children[0].value;
        const name = row.children[1].value;
        const weight = parseFloat(row.children[2].value) || 0;
        
        if (isFlour(name) && percentageGroups.includes(group)) {
          originalTotalFlour += weight;
        }
      });
      
      conversionResults = {
        status: "success",
        originalTotalFlour: originalTotalFlour,
        newTotalFlour: originalTotalFlour * conversionRatio,
        conversionRatio: conversionRatio,
        ingredients: convertedIngredients
      };
      
      displayConversionResults();
    }

    function calculateConversionFromRecipe(recipeTitle, conversionRatio, includeNonPercentage) {
      const recipe = allRecipes.find(r => r.title === recipeTitle);
      if (!recipe) {
        showNotification('找不到指定的食譜', 'error');
        return;
      }
      
      const convertedIngredients = recipe.ingredients.map(ing => {
        let originalWeight = parseFloat(ing.weight) || 0;
        let newWeight = originalWeight;
        
        if (percentageGroups.includes(ing.group) || includeNonPercentage) {
          newWeight = originalWeight * conversionRatio;
        }
        
        return {
          group: ing.group,
          name: ing.name,
          weight: newWeight,
          originalWeight: originalWeight,
          percent: ing.percent,
          desc: ing.desc || ""
        };
      });
      
      let originalTotalFlour = 0;
      recipe.ingredients.forEach(ing => {
        if (isFlour(ing.name) && percentageGroups.includes(ing.group)) {
          originalTotalFlour += parseFloat(ing.weight) || 0;
        }
      });
      
      conversionResults = {
        status: "success",
        originalTotalFlour: originalTotalFlour,
        newTotalFlour: originalTotalFlour * conversionRatio,
        conversionRatio: conversionRatio,
        ingredients: convertedIngredients,
        recipe: recipe
      };
      
      displayConversionResults();
    }

    function displayConversionResults() {
      if (!conversionResults) return;
      
      const tableContainer = document.getElementById('convertedIngredientsTable');
      let html = '<table class="converted-ingredient-table">';
      html += '<thead><tr><th>分組</th><th>食材</th><th>原始重量</th><th>新重量</th><th>變化</th><th>百分比</th><th>說明</th></tr></thead><tbody>';
      
      const groupedIngredients = {};
      conversionResults.ingredients.forEach(ing => {
        if (!groupedIngredients[ing.group]) groupedIngredients[ing.group] = [];
        groupedIngredients[ing.group].push(ing);
      });
      
      Object.keys(groupedIngredients).forEach(group => {
        html += `<tr class="ingredient-group-row"><td colspan="7"><strong>${group} 分組</strong></td></tr>`;
        
        groupedIngredients[group].forEach(ing => {
          const originalWeight = ing.originalWeight || (ing.weight / conversionResults.conversionRatio);
          const newWeight = ing.weight;
          const weightChange = newWeight - originalWeight;
          const changeClass = weightChange > 0 ? 'weight-increase' : (weightChange < 0 ? 'weight-decrease' : '');
          const changeSymbol = weightChange > 0 ? '+' : '';
          
          html += `
            <tr>
              <td></td>
              <td>${escapeHtml(ing.name)}</td>
              <td>${originalWeight.toFixed(1)}g</td>
              <td><strong>${newWeight.toFixed(1)}g</strong></td>
              <td class="weight-change ${changeClass}">${changeSymbol}${weightChange.toFixed(1)}g</td>
              <td>${formatPercentFrontend(ing.percent)}</td>
              <td>${escapeHtml(ing.desc || '-')}</td>
            </tr>
          `;
        });
      });
      
      html += '</tbody></table>';
      tableContainer.innerHTML = html;
      document.getElementById('conversionResults').style.display = 'block';
    }

    function copyConversionResults() {
      if (!conversionResults) return;
      
      let text = `食譜: ${currentConversionRecipe}\n`;
      text += `換算比例: ${conversionResults.conversionRatio.toFixed(3)} (${conversionResults.originalTotalFlour.toFixed(1)}g → ${conversionResults.newTotalFlour.toFixed(1)}g)\n\n`;
      
      const groupedIngredients = {};
      conversionResults.ingredients.forEach(ing => {
        if (!groupedIngredients[ing.group]) groupedIngredients[ing.group] = [];
        groupedIngredients[ing.group].push(ing);
      });
      
      Object.keys(groupedIngredients).forEach(group => {
        text += `【${group}】\n`;
        
        groupedIngredients[group].forEach(ing => {
          const newWeight = parseFloat(ing.weight) * conversionResults.conversionRatio;
          text += `${ing.name}: ${newWeight.toFixed(1)}g (${formatPercentFrontend(ing.percent)})`;
          if (ing.desc) text += ` - ${ing.desc}`;
          text += '\n';
        });
        
        text += '\n';
      });
      
      navigator.clipboard.writeText(text).then(function() {
        showNotification('換算結果已複製到剪貼簿', 'success');
      }, function() {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('換算結果已複製到剪貼簿', 'success');
      });
    }

    function applyConversionToForm() {
      if (!conversionResults || !editingTitle) {
        showNotification('無法應用到表單，請確認正在編輯食譜', 'error');
        return;
      }
      
      document.getElementById("ingredients-container").innerHTML = "";
      currentGroups = {};
      
      conversionResults.ingredients.forEach(ing => {
        addIngredientRow(ing.name, ing.weight.toFixed(1), ing.percent, ing.desc, ing.group);
      });
      
      calcPercentages();
      calcHydration();
      
      closeConversionModal();
      showNotification('換算結果已應用到編輯表單', 'success');
      
      updateConversionToolButton();
    }

// 食譜計時器功能
function openRecipeTimer(recipe) {
  // 在新窗口打開計時器網站
  const timerUrl = "https://teng-recipe.onrender.com";
  window.open(timerUrl, '_blank');
  
  // 可選：可以將食譜信息傳遞給計時器
  // 這裡只是簡單地打開連結，如果需要傳遞數據，可以通過 URL 參數或其他方式
  showNotification('已開啟食譜計時器', 'info');
}
    
    // 匯入模態窗口函數
    function openImportModal() {
      document.getElementById('importModal').classList.add('active');
      document.getElementById('csvFile').value = '';
      document.getElementById('importProgress').style.display = 'none';
      document.getElementById('importBtn').disabled = false;
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('active');
    }

    // 初始化事件監聽器
    document.addEventListener('DOMContentLoaded', function() {
      // 換算選項按鈕點擊事件
      document.querySelectorAll('.conversion-option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.conversion-option-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const ratio = parseFloat(this.getAttribute('data-ratio'));
          const originalFlour = parseFloat(document.getElementById('originalFlour').value);
          const newFlour = originalFlour * ratio;
          
          document.getElementById('newFlour').value = newFlour.toFixed(1);
          document.getElementById('conversionRatio').value = ratio.toFixed(3);
        });
      });
      
      // 新麵粉量輸入框變化事件
      document.getElementById('newFlour').addEventListener('input', function() {
        document.querySelectorAll('.conversion-option-btn').forEach(b => b.classList.remove('active'));
        
        const originalFlour = parseFloat(document.getElementById('originalFlour').value);
        const newFlour = parseFloat(this.value) || 0;
        
        if (newFlour > 0 && originalFlour > 0) {
          const ratio = newFlour / originalFlour;
          document.getElementById('conversionRatio').value = ratio.toFixed(3);
        }
      });
      
      // 初始化應用
      init();
    });

    // 頁面載入時初始化
    window.onload = init;
  </script>
</body>
</html>
